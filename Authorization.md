## Authorization

The Alexa Voice Service (AVS) Device SDK for C++ relies on Login with Amazon (LWA) to authorize your client to use AVS.

Select your platform:

* [Android](https://github.com/alexa/avs-device-sdk/wiki/Authorization#Android)
* [Generic Linux](https://github.com/alexa/avs-device-sdk/wiki/Authorization#Generic-Linux)
* [macOS or Ubuntu Linux 16.04 LTS](https://github.com/alexa/avs-device-sdk/wiki/authorization#macos-ubuntu-linux-1604-lts)
* [Raspberry Pi](https://github.com/alexa/avs-device-sdk/wiki/Authorization#raspberry-pi)
* [Windows](https://github.com/alexa/avs-device-sdk/wiki/Authorization#Windows)

## Android

If you haven't already, you'll need to download installation script and configuration file, as explained in the [Android guide](https://github.com/alexa/avs-device-sdk/wiki/Android-Quick-Start-Guide). You can specify any directory you prefer to run the scripts and download these files to. The following commands will download all the necessary files:
```sh
wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/androidConfig.txt
wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/setup.sh
wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/genConfig.sh
wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/android.sh
```

### Configuration

In order to build and run the sample app, you'll need to set the configuration values for your device.

Follow these steps:

1. Navigate to the directory where you downloaded the setup script.


2. Update `androidConfig.txt` with the following variables:

| Parameter              | Value                                                                                                                                                                                                                                                             |
|------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `PLATFORM`             | This variable should be set to `"android"`.                                                                                                                                                                                                                       |
| `API_LEVEL`            | The Android API level. See [this table](https://source.android.com/setup/start/build-numbers) to identify the target level. The API level will depend on the device or emulator configuration.  <br> <br> **Supported version**: API 23+ or greater is supported. |
| `TARGET_SYSTEM`        | Choose this value according to the CPU architecture of your target device. For example, choose `arm` for the Raspberry Pi. <br> <br> **Accepted values**: `arm` and `x86`.                                                                                        |
| `DEVICE_INSTALL_PATH`  | The file path on the device where the script should install the sample app and dependencies.  <br> <br> **Note:** Make sure this path exists on the device, and that you have write permissions.                                                                  |
| `BUILD_TYPE`           | The type of build that will be used.  <br> <br> **Accepted values**: `debug`, `release`, `MinSizeRel`, and `RelWithDebInfo`.                                                                                                                                      |

3. Run the setup script with `config.json` and the device serial number (DSN) as arguments. You can either provide your own DSN, or use the system default (`123456`). The DSN can be any unique alpha-numeric string (up to 64 characters). You should use this string to identify your product or application instance. Many developers choose to use a product's SKU for this value.

For example:

```
sudo bash setup.sh config.json -a androidConfig.txt -s 998987
```

**Note**: If you don't supply a DSN, then the default value `123456` will be generated by the SDK.

### Run and authorize

When you run the sample app for the first time, you'll need to authorize your client for access to AVS.

1. Start the sample app using the `startsample.sh` script.

 Note: this script is a batch file, and not a bash script. You can run the script either from the command line, or by locating the file and then double-clicking it.

`bash startsample.sh`

2. Wait for the sample app to display a message like this:
```sh
##################################
#       NOT YET AUTHORIZED       #
##################################
################################################################################################
#       To authorize, browse to: 'https://amazon.com/us/code' and enter the code: {XXXX}       #
################################################################################################
```
3. Use a browser to navigate to the URL specified in the message from the sample app.
4. If requested to do so, authenticate using your Amazon user credentials.
5. Enter the code specified in the message from sample app.
6. Select “Allow”.
7. Wait (it may take a few seconds) for the sample app to report that it is authorized, and that Alexa is idle.  It will look something like this:
```sh
###########################
#       Authorized!       #
###########################
########################################
#       Alexa is currently idle!       #
########################################
```
8. You are now ready to use the sample app. The next time you start the sample app, you will not need to go through the authorization process.

Note: if you exit out of sample app via the `k` command, the `CBLAuthDelegate` database will be cleared, and you will need to reauthorize your client.

## Generic Linux

### Configuration

`genConfig.sh` is a configuration file generator script that is included with v1.10.0 or greater of the SDK, located in the **tools/Install** folder. It uses data from **config.json** and the arguments below, to populate `AlexaClientSDKConfig.json` in order to authorize with LWA.

Follow these steps to setup `AlexaClientSDKConfig.json` using `genConfig.sh`:

1. Move the **config.json** you downloaded when you [created your security profile](https://github.com/alexa/avs-device-sdk/wiki/Create-Security-Profile#create-a-security-profile) into the **tools/Install** folder of the SDK.

    ```sh
    mv ~/{download location}/config.json
    {path_to}/{source}/avs-device-sdk/tools/Install
    ```

    **config.json** should be populated with the `clientID` and `productID` values generate in the Security Profile process.

    Example:

    ```sh
        {
         "deviceInfo": {
          "clientId": "amzn1.application-oa2-client.{{string}}",
          "productId": "Test_123"
         }
        }
    ```

2. Run `genConfig.sh`, including the following as arguments:

    ```sh
    cd {source}/avs-device-sdk/tools/Install

    bash genConfig.sh config.json {deviceSerialNumber} \
    /{database} \
    {path_to}/{source}/avs-device-sdk \
    {path_to}/{build}/Integration/AlexaClientSDKConfig.json
    ```

    Parameters:

    * `config.json`: Downloaded when you created your security profile. It should contain the following:
        ```
        "clientId": "{OAuth client ID}"
        "productId": "{product name for the device}"
        ```
    * **{deviceSerialNumber}**: You can provide your own device serial number (DSN), or use the system default
    (`123456`). The DSN can be any unique alpha-numeric string (up to 64 characters). You should use this string
    to identify your product or application instance. Many developers choose to use a product's SKU for this
    value.

        For example:

        ```sh
        sudo bash config.json -s 998987
        ```
        **Note**: If you don't supply a DSN, then the default value `123456` will be generated by the SDK.
    * **{database}**: Specifies where the databases will be located.
    * **{source}**: Specifies the root directory where the avs-device-sdk source code is located.
    * **{build}**: Specifies where the build folder is, which contains the **Integration/AlexaClientSDKConfig.json** file.

**IMPORTANT**: Create a backup of your `AlexaClientSDKConfig.json` file. Subsequent builds will reset the contents of this file.

### Run and authorize

Navigate to your **build** folder, then:
1. Start the sample app:
```shell
./SampleApp/src/SampleApp ./Integration/AlexaClientSDKConfig.json
```
2. Wait for the sample app to display a message like this:
```shell
##################################
#       NOT YET AUTHORIZED       #
##################################
################################################################################################
#       To authorize, browse to: 'https://amazon.com/us/code' and enter the code: {XXXX}       #
################################################################################################
```
3. Use a browser to navigate to the URL specified in the message from the sample app.
4. If requested to do so, authenticate using your Amazon user credentials.
5. Enter the code specified in the message from sample app.
6. Select **Allow**.
7. Wait for the sample app to report that it is authorized, and that Alexa is idle.  It will look something like this:
```shell
###########################
#       Authorized!       #
###########################
########################################
#       Alexa is currently idle!       #
########################################
```
8. You are now ready to use the sample app. The next time you start the sample app, you will not need to go through the authorization process.

A couple more details:
* If you exit out of sample app via the `k` command, the `CBLAuthDelegate` database will be cleared and you will need to reauthorize your client.
* If you want to move this authorization to another sample app installation, you need to copy the **deviceInfo** object within `AlexaClientSDKConfig.json` to the new installation.  You will also need to copy the file `"/{application-necessities}/cblAuthDelegate.db"` to the new installation, and update **AlexaClientSDKConfig.json** in the new installation so that the **cblAuthDelegate's databaseFilePath** property points to it.

## macOS, Ubuntu Linux 16.04 LTS

### Configuration

The sample app uses data in `AlexaClientSDKConfig.json` to obtain a refresh token which, along with your **Client ID** and **Product ID**, will be exchanged with Login With Amazon (LWA) to gain access tokens.

`genConfig.sh` is a configuration file generator script that is included with v1.10.0 or greater of the SDK, located in the **tools/Install** folder. It uses data from **config.json** and the arguments below, to populate `AlexaClientSDKConfig.json` in order to authorize with LWA.

Follow these steps to set up `AlexaClientSDKConfig.json` using `genConfig.sh`; replace `~` with the path to your `home` directory.

1. Move the **config.json** you downloaded when you [created your security profile](https://github.com/alexa/avs-device-sdk/wiki/Create-Security-Profile#create-a-security-profile) into the **tools/Install** folder of the SDK.

    ```sh
    mv ~/{download location}/config.json
    ~/{my_project}/source/avs-device-sdk/tools/Install
    ```

    **config.json** should be populated with the `clientID` and `productID` values generated in the Security Profile process.

    Example:

    ```sh
        {
         "deviceInfo": {
          "clientId": "amzn1.application-oa2-client.{string}",
          "productId": "Test_123"
         }
        }
    ```

2. Navigate to **~/my_project/source/avs-device-sdk/tools/Install** and run `genConfig.sh`, including the following arguments:

    ```sh
    cd ~/{my_project}/{source}/avs-device-sdk/tools/Install

    bash genConfig.sh config.json {device serial number} \
    /{database} \
    /{source}/avs-device-sdk \
    /{build}/Integration/AlexaClientSDKConfig.json
    ```

    Parameters:

    * `config.json`: Downloaded when you created your security profile. It should contain the following:
        ```
        "clientId": "{OAuth client ID}"
        "productId": "{product name for the device}"
        ```
    * **{device serial number}**: You can provide your own device serial number (DSN), or use the system default
    (`123456`). The DSN can be any unique alpha-numeric string (up to 64 characters). You should use this string
    to identify your product or application instance. Many developers choose to use a product's SKU for this
    value.

        For example:

        ```sh
        sudo bash config.json -s 998987
        ```
        **Note**: If you don't supply a DSN, then the default value `123456` will be generated by the SDK.
    * **{database}**: Specifies where the databases will be located.
    * **{source}**: Specifies the root directory where the avs-device-sdk source code is located.
    * **{build}**: Specifies where the build folder is, which contains the **Integration/AlexaClientSDKConfig.json** file.

**IMPORTANT**: Create a backup of your `AlexaClientSDKConfig.json` file. Subsequent builds will reset the contents of this file.

### Run and authorize

Navigate to your **build** folder, then:
1. Initialize the sample app:
```shell
./SampleApp/src/SampleApp ./Integration/AlexaClientSDKConfig.json
```
2. Wait for the sample app to display a message like this:
```shell
##################################
#       NOT YET AUTHORIZED       #
##################################
################################################################################################
#       To authorize, browse to: 'https://amazon.com/us/code' and enter the code: {XXXX}       #
################################################################################################
```
3. Use a browser to navigate to the URL specified in the message from the sample app.
4. If requested to do so, authenticate using your Amazon user credentials.
5. Enter the code specified in the message from sample app.
6. Select “Allow”.
7. Wait for the sample app to report that it is authorized, and that Alexa is idle.  It will look something like this:
```shell
###########################
#       Authorized!       #
###########################
########################################
#       Alexa is currently idle!       #
########################################
```
8. You are now ready to use the sample app. The next time you start the sample app, you will not need to go through the authorization process.

A couple more details:
* If you exit out of sample app via the `k` command, the `CBLAuthDelegate` database will be cleared and you will need to reauthorize your client.
* If you want to move this authorization to another sample app installation, you need to copy the **deviceInfo** object within `AlexaClientSDKConfig.json` to the new installation. You will also need to copy the file `"/~/my_project/application-necessities/cblAuthDelegate.db"` to the new installation, and update **AlexaClientSDKConfig.json** in the new installation so that the **cblAuthDelegate's databaseFilePath** property points to it.

## Raspberry Pi (with script)

If you haven't already, you'll need to download installation script and configuration file, as explained in the [Raspberry quick start guide](https://github.com/alexa/avs-device-sdk/wiki/Raspberry-Pi-Quick-Start-Guide-with-Script). You can specify any directory you prefer to run the scripts and download these files to.

We recommend running these commands from the home directory (`~/`) or Desktop; however, you can run the script anywhere:
    ```sh
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/setup.sh \
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/genConfig.sh \
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/pi.sh
    ```

### Configuration

1. Move the **config.json** file that you downloaded when you [created your Security Profile](https://github.com/alexa/avs-device-sdk/wiki/Create-Security-Profile#create-a-security-profile) to your home directory.

2. Run the setup script with `config.json` and the device serial number (DSN) as arguments. You can either provide your own DSN, or use the system default (`123456`). The DSN can be any unique alpha-numeric string (up to 64 characters). You should use this string to identify your product or application instance. Many developers choose to use a product's SKU for this value.

    For example:

    ```
    sudo bash setup.sh config.json -s 998987
    ```

    **Note**: If you don't supply a DSN, then the default value `123456` will be generated by the SDK.

### Run and Authorize

When you run the sample app for the first time, you'll need to authorize your client for access to AVS.

1. Initialize the sample app:
   ```sh
   sudo bash startsample.sh
   ```  
2. Wait for the sample app to display a message like this:
   ```sh
   ######################################################
   #       > > > > > NOT YET AUTHORIZED < < < < <       #
   ######################################################

   ############################################################################################
   #     To authorize, browse to: 'https://amazon.com/us/code' and enter the code: {XXXX}     #
   ############################################################################################
   ```
3. Use a browser to navigate to the URL specified in the message from the sample app.
4. Authenticate using your Amazon user credentials.
5. Enter the code specified in the message from sample app.
6. Select “Allow”.
7. Wait (it may take as long as 30 seconds) for `CBLAuthDelegate` to successfully get an access and refresh token from Login With Amazon (LWA). At this point the sample app will print a message like this:
   ```sh
   ########################################
   #       Alexa is currently idle!       #
   ########################################
   ```
8. You are now ready to use the sample app. The next time you start the sample app, you will not need to go through the authorization process.

## Windows

If you haven't already, you'll need to download installation script and configuration file, as explained in the [Windows guide](https://github.com/alexa/avs-device-sdk/wiki/Windows-Quick-Start-Guide-with-Script).

To do this, open the MinGW64 shell, and run this command to download the installation and configuration scripts:
    ```sh
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/setup.sh \
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/genConfig.sh \
    wget https://raw.githubusercontent.com/alexa/avs-device-sdk/master/tools/Install/mingw.sh
    ```
    Note: we recommend running these commands from your home directory (`C:/msys64/home/<user_name>`) or your desktop, however, you can run the script anywhere.

### Configuration

1. Move the **config.json** file that you downloaded when you [created your Security Profile](https://github.com/alexa/avs-device-sdk/wiki/Create-Security-Profile#create-a-security-profile) to your **home** directory.

2. Using the MinGW64 shell, run the setup script with `config.json` and the device serial number (DSN) as arguments. You can either provide your own DSN, or use the system default (`123456`). The DSN can be any unique alpha-numeric string (up to 64 characters). You should use this string to identify your product or application instance. Many developers choose to use a product's SKU for this value.

    For example:

    ```
    bash setup.sh config.json -s 998987
    ```

    **Note**: If you don't supply a DSN, then the default value `123456` will be generated by the SDK.

### Run and authorize

When you run the sample app for the first time, you'll need to authorize your client for access to AVS.

1. Start the sample app using the `startsample.bat` file. Note: this script is a batch file, and not a bash script. You can run the script either from the Windows command line, or by using the Windows File Explorer to locate the file and then double-clicking it.

2. Wait for the sample app to display a message like this:
```sh
##################################
#       NOT YET AUTHORIZED       #
##################################
################################################################################################
#       To authorize, browse to: 'https://amazon.com/us/code' and enter the code: {XXXX}       #
################################################################################################
```
3. Use a browser to navigate to the URL specified in the message from the sample app.
4. If requested to do so, authenticate using your Amazon user credentials.
5. Enter the code specified in the message from sample app.
6. Select “Allow”.
7. Wait for the sample app to report that it is authorized, and that Alexa is idle.  It will look something like this:
```sh
###########################
#       Authorized!       #
###########################
########################################
#       Alexa is currently idle!       #
########################################
```
8. You are now ready to use the sample app. The next time you start the sample app, you will not need to go through the authorization process.

Note: if you exit out of sample app via the `k` command, the `CBLAuthDelegate` database will be cleared, and you will need to reauthorize your client.